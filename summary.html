<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ZANDAKA | サマリー</title>
    <meta name="theme-color" content="#111827" />
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%23111827'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial' font-size='56' fill='%23fff'%3E%E5%89%B2%3C/text%3E%3C/svg%3E"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .summary-header {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .summary-back {
        text-decoration: none;
        color: var(--text);
        border: 1px solid var(--border);
        padding: 8px 12px;
        border-radius: 10px;
      }
      .summary-back:hover {
        border-color: rgba(124, 58, 237, 0.6);
      }
      .stats {
        max-width: 1200px;
        margin: 0 auto;
        padding: 12px 20px 40px;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
      }
      .stat-card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.005)
        );
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 20px;
      }
      .stat-title {
        margin: 0 0 10px 0;
        font-size: 13px;
        color: var(--muted);
        letter-spacing: 0.08em;
      }
      .stat-amount {
        font-size: 32px;
        font-weight: 700;
        letter-spacing: 0.02em;
      }
      .stat-amount.plus {
        color: var(--ok);
      }
      .stat-amount.minus {
        color: var(--danger);
      }
      .ratio {
        grid-column: span 2;
        background: #0c1429;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
      }
      .bar {
        height: 14px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        overflow: hidden;
      }
      .bar > div {
        height: 100%;
        background: linear-gradient(
          135deg,
          rgba(124, 58, 237, 0.8),
          rgba(6, 182, 212, 0.7)
        );
      }
      .ratio-caption {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
      }
      @media (max-width: 900px) {
        .stats {
          grid-template-columns: 1fr;
        }
        .ratio {
          grid-column: span 1;
        }
      }
      /* iPhone-friendly tightening */
      @media (max-width: 390px) {
        .summary-header,
        .stats {
          padding-left: 12px;
          padding-right: 12px;
        }
        .stat-card {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>
    <header class="summary-header">
      <div class="brand">
        <div class="logo">残</div>
        <div>
          <h1>ZANDAKA</h1>
          <p class="subtitle">総収入・総支出サマリー</p>
        </div>
      </div>
      <a href="./index.html" class="summary-back">戻る</a>
    </header>
    <main class="stats">
      <section class="stat-card">
        <h2 class="stat-title">これまでの総収入</h2>
        <div id="total-income" class="stat-amount plus">¥0</div>
      </section>
      <section class="stat-card">
        <h2 class="stat-title">これまでの総支出</h2>
        <div id="total-expense" class="stat-amount minus">¥0</div>
      </section>
      <section class="ratio">
        <div class="bar"><div id="ratio-bar" style="width: 0%"></div></div>
        <div class="ratio-caption">
          <span id="ratio-left">支出 0%</span>
          <span id="ratio-right">収入 0%</span>
        </div>
      </section>
      <section class="stat-card" style="grid-column: span 2">
        <h2 class="stat-title">未来予定支出（メモ）</h2>
        <div
          id="planned-summary-total"
          class="stat-amount minus"
          style="font-size: 24px"
        >
          ¥0
        </div>
        <div
          id="planned-summary"
          class="entries"
          style="margin-top: 12px"
        ></div>
      </section>
    </main>
    <script>
      const STORAGE_KEY = "zandaka/v1";
      const yen = new Intl.NumberFormat("ja-JP", {
        style: "currency",
        currency: "JPY",
        maximumFractionDigits: 0,
      });
      const toInt = (s) => {
        if (typeof s === "number") return Math.round(s);
        if (!s) return 0;
        return Math.round(Number(String(s).replace(/[^\\d-]/g, "")) || 0);
      };
      const toDate = (s) => new Date(s + "T00:00:00");
      const ymd = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + dd;
      };
      const addMonthsClamp = (date, months) => {
        const d = new Date(date);
        const day = d.getDate();
        d.setDate(1);
        d.setMonth(d.getMonth() + months);
        const last = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
        d.setDate(Math.min(day, last));
        return d;
      };
      function nthMondayOfMonth(year, month0, n) {
        let d = new Date(year, month0, 1);
        const day = d.getDay();
        const offset = (8 - day) % 7;
        d.setDate(1 + offset + (n - 1) * 7);
        return d;
      }
      function calcVernalEquinoxDay(year) {
        const day =
          Math.floor(20.8431 + 0.242194 * (year - 1980)) -
          Math.floor((year - 1980) / 4);
        return new Date(year, 2, day);
      }
      function calcAutumnEquinoxDay(year) {
        const day =
          Math.floor(23.2488 + 0.242194 * (year - 1980)) -
          Math.floor((year - 1980) / 4);
        return new Date(year, 8, day);
      }
      function buildJapaneseHolidays(year) {
        const days = [];
        days.push(new Date(year, 0, 1));
        days.push(new Date(year, 1, 11));
        days.push(new Date(year, 1, 23));
        days.push(calcVernalEquinoxDay(year));
        days.push(new Date(year, 3, 29));
        days.push(new Date(year, 4, 3));
        days.push(new Date(year, 4, 4));
        days.push(new Date(year, 4, 5));
        days.push(new Date(year, 7, 11));
        days.push(calcAutumnEquinoxDay(year));
        days.push(new Date(year, 10, 3));
        days.push(new Date(year, 10, 23));
        days.push(nthMondayOfMonth(year, 0, 2));
        days.push(nthMondayOfMonth(year, 6, 3));
        days.push(nthMondayOfMonth(year, 8, 3));
        days.push(nthMondayOfMonth(year, 9, 2));
        const set = new Set();
        for (const d of days) {
          const s = ymd(d);
          set.add(s);
          if (d.getDay() === 0) {
            let sub = new Date(d);
            do {
              sub.setDate(sub.getDate() + 1);
            } while (sub.getDay() === 0 || set.has(ymd(sub)));
            set.add(ymd(sub));
          }
        }
        return set;
      }
      function isWeekend(d) {
        const wd = d.getDay();
        return wd === 0 || wd === 6;
      }
      function adjustToBusinessDay(d, hol) {
        const x = new Date(d);
        while (isWeekend(x) || hol.has(ymd(x))) {
          x.setDate(x.getDate() + 1);
        }
        return x;
      }
      function expand(entries, endYmd) {
        const res = [];
        const end = toDate(endYmd);
        const holCache = {};
        for (const e of entries) {
          if (e.kind === "future-small" || e.kind === "future-large") continue;
          if (!e.recurring) {
            if (toDate(e.date) <= end) res.push(e);
            continue;
          }
          let cur = toDate(e.date);
          const endLimit = e.endDate ? toDate(e.endDate) : end;
          while (cur <= end && cur <= endLimit) {
            const y = cur.getFullYear();
            if (!holCache[y]) holCache[y] = buildJapaneseHolidays(y);
            const adj = adjustToBusinessDay(cur, holCache[y]);
            if (adj <= end) {
              res.push({ ...e, date: ymd(adj), _recurrenceInstance: true });
            }
            cur = addMonthsClamp(cur, 1);
          }
        }
        return res;
      }
      function loadState() {
        try {
          // Prefer localStorage
          const ls = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
          if (ls && Array.isArray(ls.entries) && ls.entries.length) return ls;
        } catch {}
        // Fallback: read from URL hash (d=base64json)
        try {
          const m = location.hash.match(/d=([^&]+)/);
          if (m && m[1]) {
            const json = decodeURIComponent(escape(atob(m[1])));
            const data = JSON.parse(json);
            if (data && Array.isArray(data.entries)) return data;
          }
        } catch {}
        return {};
      }
      function renderPlanned(all) {
        const root = document.getElementById("planned-summary");
        const totalEl = document.getElementById("planned-summary-total");
        if (!root || !totalEl) return;
        const planned = (all || []).filter(
          (e) => e.kind === "future-small" || e.kind === "future-large"
        );
        if (!planned.length) {
          root.innerHTML =
            '<div class="tiny muted">未来予定支出のメモはまだありません。</div>';
          totalEl.textContent = yen.format(0);
          return;
        }
        let total = 0;
        const frags = [];
        const esc = (s) =>
          String(s).replace(
            /[&<>"]/g,
            (c) =>
              ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c])
          );
        planned.sort((a, b) =>
          String(a.date || "").localeCompare(String(b.date || ""))
        );
        for (const e of planned) {
          total += toInt(e.amount);
          frags.push(
            '<div class="entry">' +
              '<span class="tag future-large">未来予定支出</span>' +
              "<div><div>" +
              (e.note
                ? esc(e.note)
                : '<span class="muted">（メモなし）</span>') +
              "</div>" +
              '<div class="tiny muted">' +
              (e.date || "日付未定") +
              "</span></div></div>" +
              '<div class="amount minus">-' +
              yen.format(toInt(e.amount)) +
              "</div>" +
              "</div>"
          );
        }
        totalEl.textContent = yen.format(total);
        root.innerHTML = frags.join("");
      }
      (function render() {
        const state = loadState();
        const todayYmd = new Date().toISOString().slice(0, 10);
        const all = Array.isArray(state.entries) ? state.entries : [];
        const expanded = expand(all, todayYmd);
        let income = 0,
          expense = 0;
        for (const e of expanded) {
          const a = toInt(e.amount);
          if (e.kind === "income") income += a;
          else if (e.kind === "expense") expense += a;
        }
        // Fallback: if expanded is 0 but entries exist, sum all entries regardless of date
        if (income + expense === 0 && all.length > 0) {
          for (const e of all) {
            const a = toInt(e.amount);
            if (e.kind === "income") income += a;
            else if (e.kind === "expense") expense += a;
          }
        }
        document.getElementById("total-income").textContent =
          yen.format(income);
        document.getElementById("total-expense").textContent =
          yen.format(expense);
        const total = income + expense; // for ratio purposes
        const spendRatio = total ? Math.round((expense / total) * 100) : 0;
        document.getElementById("ratio-bar").style.width =
          (income + expense === 0
            ? 0
            : Math.min(100, (100 * expense) / (income + expense))) + "%";
        document.getElementById("ratio-left").textContent =
          "支出 " + spendRatio + "%";
        document.getElementById("ratio-right").textContent =
          "収入 " + (100 - spendRatio) + "%";
        // planned summary render
        renderPlanned(all);
      })();
    </script>
  </body>
</html>
